using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using ConVar;
using Facepunch;
using Facepunch.Math;
using Network;
using UnityEngine;

[Factory("chat")]
public class Chat : ConsoleSystem
{
	public enum ChatChannel
	{
		Global,
		Team,
		Server
	}

	public struct ChatEntry
	{
		public ChatChannel Channel { get; set; }

		public string Message { get; set; }

		public string UserId { get; set; }

		public string Username { get; set; }

		public string Color { get; set; }

		public int Time { get; set; }
	}

	private const float textRange = 50f;

	private const float textVolumeBoost = 0.2f;

	[ClientVar]
	[ServerVar]
	public static bool enabled = true;

	public static List<ChatEntry> History = new List<ChatEntry>();

	[ServerVar]
	public static bool serverlog = true;

	public static void Broadcast(string message, string username = "SERVER", string color = "#eee", ulong userid = 0uL)
	{
		string text = username.EscapeRichText();
		ConsoleNetwork.BroadcastToAllClients("chat.add", 2, 0, "<color=" + color + ">" + text + "</color> " + message);
		ChatEntry chatEntry = default(ChatEntry);
		chatEntry.Channel = ChatChannel.Server;
		chatEntry.Message = message;
		chatEntry.UserId = userid.ToString();
		chatEntry.Username = username;
		chatEntry.Color = color;
		chatEntry.Time = Epoch.Current;
		ChatEntry chatEntry2 = chatEntry;
		History.Add(chatEntry2);
		RCon.Broadcast(RCon.LogType.Chat, chatEntry2);
	}

	[ServerUserVar]
	public static void say(Arg arg)
	{
		if (!enabled)
		{
			arg.ReplyWith("Chat is disabled.");
			return;
		}
		BasePlayer basePlayer = ArgEx.Player(arg);
		if (!basePlayer || basePlayer.HasPlayerFlag(BasePlayer.PlayerFlags.ChatMute))
		{
			return;
		}
		if (!basePlayer.IsAdmin && !basePlayer.IsDeveloper)
		{
			if (basePlayer.NextChatTime == 0f)
			{
				basePlayer.NextChatTime = UnityEngine.Time.realtimeSinceStartup - 30f;
			}
			if (basePlayer.NextChatTime > UnityEngine.Time.realtimeSinceStartup)
			{
				basePlayer.NextChatTime += 2f;
				float num = basePlayer.NextChatTime - UnityEngine.Time.realtimeSinceStartup;
				ConsoleNetwork.SendClientCommand(basePlayer.net.connection, "chat.add", 2, 0, "You're chatting too fast - try again in " + (num + 0.5f).ToString("0") + " seconds");
				if (num > 120f)
				{
					basePlayer.Kick("Chatting too fast");
				}
				return;
			}
		}
		ChatChannel @int = (ChatChannel)arg.GetInt(0);
		string text = arg.GetString(1, "text").Replace("\n", "").Replace("\r", "")
			.Trim();
		if (text.Length > 128)
		{
			text = text.Substring(1, 128);
		}
		if (text.Length <= 0 || text.StartsWith("/") || text.StartsWith("\\"))
		{
			return;
		}
		text = text.EscapeRichText();
		if (serverlog)
		{
			ServerConsole.PrintColoured(ConsoleColor.DarkYellow, "[" + @int.ToString() + "] " + basePlayer.displayName + ": ", ConsoleColor.DarkGreen, text);
			if (@int == ChatChannel.Team)
			{
				DebugEx.Log($"[TEAM CHAT] {basePlayer.ToString()} : {text}");
			}
			else
			{
				DebugEx.Log($"[CHAT] {basePlayer.ToString()} : {text}");
			}
		}
		string text2 = "#5af";
		if (basePlayer.IsAdmin)
		{
			text2 = "#af5";
		}
		if (basePlayer.IsDeveloper)
		{
			text2 = "#fa5";
		}
		string text3 = basePlayer.displayName.EscapeRichText();
		basePlayer.NextChatTime = UnityEngine.Time.realtimeSinceStartup + 1.5f;
		ChatEntry chatEntry = default(ChatEntry);
		chatEntry.Channel = @int;
		chatEntry.Message = text;
		chatEntry.UserId = basePlayer.UserIDString;
		chatEntry.Username = basePlayer.displayName;
		chatEntry.Color = text2;
		chatEntry.Time = Epoch.Current;
		ChatEntry chatEntry2 = chatEntry;
		History.Add(chatEntry2);
		RCon.Broadcast(RCon.LogType.Chat, chatEntry2);
		switch (@int)
		{
		case ChatChannel.Global:
			if (ConVar.Server.globalchat)
			{
				ConsoleNetwork.BroadcastToAllClients("chat.add2", 0, basePlayer.userID, text, text3, text2, 1f);
				arg.ReplyWith("");
				return;
			}
			break;
		case ChatChannel.Team:
		{
			List<Connection> list = ArgEx.Player(arg).Team?.GetOnlineMemberConnections();
			if (list != null)
			{
				ConsoleNetwork.SendClientCommand(list, "chat.add2", 1, basePlayer.userID, text, text3, text2, 1f);
			}
			return;
		}
		}
		float num2 = 2500f;
		foreach (BasePlayer activePlayer in BasePlayer.activePlayerList)
		{
			float sqrMagnitude = (activePlayer.transform.position - basePlayer.transform.position).sqrMagnitude;
			if (!(sqrMagnitude > num2))
			{
				ConsoleNetwork.SendClientCommand(activePlayer.net.connection, "chat.add2", 0, basePlayer.userID, text, text3, text2, Mathf.Clamp01(num2 - sqrMagnitude + 0.2f));
			}
		}
		arg.ReplyWith("");
	}

	[Help("Return the last x lines of the console. Default is 200")]
	[ServerVar]
	public static IEnumerable<ChatEntry> tail(Arg arg)
	{
		int @int = arg.GetInt(0, 200);
		int num = History.Count - @int;
		if (num < 0)
		{
			num = 0;
		}
		return History.Skip(num);
	}

	[ServerVar]
	[Help("Search the console for a particular string")]
	public static IEnumerable<ChatEntry> search(Arg arg)
	{
		string search = arg.GetString(0, null);
		if (search == null)
		{
			return Enumerable.Empty<ChatEntry>();
		}
		return History.Where((ChatEntry x) => x.Message.Length < 4096 && x.Message.Contains(search, CompareOptions.IgnoreCase));
	}
}
