using System;
using System.Collections.Generic;
using Facepunch;
using UnityEngine;

public class MeshPaintableSource : MonoBehaviour, IClientComponent
{
	public int texWidth = 256;

	public int texHeight = 128;

	public string replacementTextureName = "_DecalTexture";

	public float cameraFOV = 60f;

	public float cameraDistance = 2f;

	[NonSerialized]
	public Texture2D texture;

	public GameObject sourceObject;

	public Mesh collisionMesh;

	public Vector3 localPosition;

	public Vector3 localRotation;

	private static MaterialPropertyBlock block;

	public void Init()
	{
		if ((bool)texture)
		{
			return;
		}
		texture = new Texture2D(texWidth, texHeight, TextureFormat.ARGB32, mipmap: false);
		texture.name = "MeshPaintableSource_" + base.gameObject.name;
		TextureEx.Clear(texture, Color.clear);
		if (block == null)
		{
			block = new MaterialPropertyBlock();
		}
		else
		{
			block.Clear();
		}
		block.SetTexture(replacementTextureName, texture);
		List<Renderer> obj = Pool.GetList<Renderer>();
		base.transform.root.GetComponentsInChildren(includeInactive: true, obj);
		foreach (Renderer item in obj)
		{
			item.SetPropertyBlock(block);
		}
		Pool.FreeList(ref obj);
	}

	public void Free()
	{
		if ((bool)texture)
		{
			UnityEngine.Object.Destroy(texture);
			texture = null;
		}
	}

	public void UpdateFrom(Texture2D input)
	{
		Init();
		texture.SetPixels32(input.GetPixels32());
		texture.Apply(updateMipmaps: true, makeNoLongerReadable: false);
	}

	public void Load(byte[] data)
	{
		Init();
		if (data != null)
		{
			texture.LoadImage(data);
			texture.Apply(updateMipmaps: true, makeNoLongerReadable: false);
		}
	}
}
