using System;
using System.Runtime.InteropServices;
using UnityEngine;

public static class SelfCheck
{
	public static bool Run()
	{
		if (FileSystem_AssetBundles.isError)
		{
			return Failed("Asset Bundle Error: " + FileSystem_AssetBundles.loadingError);
		}
		GameManifest gameManifest = FileSystem.Load<GameManifest>("Assets/manifest.asset");
		if (gameManifest == null)
		{
			return Failed("Couldn't load game manifest - verify your game content!");
		}
		if (!TestRustNative())
		{
			return false;
		}
		return true;
	}

	private static bool Failed(string Message)
	{
		if ((bool)SingletonComponent<Bootstrap>.Instance)
		{
			SingletonComponent<Bootstrap>.Instance.messageString = string.Empty;
			SingletonComponent<Bootstrap>.Instance.ThrowError(Message);
		}
		Debug.LogError("SelfCheck Failed: " + Message);
		return false;
	}

	private static bool TestRustNative()
	{
		try
		{
			if (!RustNative_VersionCheck(5))
			{
				return Failed("RustNative is wrong version!");
			}
		}
		catch (DllNotFoundException ex)
		{
			return Failed("RustNative library couldn't load! " + ex.Message);
		}
		return true;
	}

	[DllImport("RustNative")]
	private static extern bool RustNative_VersionCheck(int version);
}
