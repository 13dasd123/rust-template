using System.Collections.Generic;
using UnityEngine;

public class TerrainPath : TerrainExtension
{
	internal List<PathList> Roads = new List<PathList>();

	internal List<PathList> Bridges = new List<PathList>();

	internal List<PathList> Rivers = new List<PathList>();

	internal List<PathList> Powerlines = new List<PathList>();

	internal List<MonumentInfo> Monuments = new List<MonumentInfo>();

	internal List<RiverInfo> RiverObjs = new List<RiverInfo>();

	internal List<LakeInfo> LakeObjs = new List<LakeInfo>();

	private Dictionary<InfrastructureType, List<TerrainPathConnect>> targets = new Dictionary<InfrastructureType, List<TerrainPathConnect>>();

	private Dictionary<string, List<PowerlineNode>> wires = new Dictionary<string, List<PowerlineNode>>();

	public void Clear()
	{
		Roads.Clear();
		Bridges.Clear();
		Rivers.Clear();
		Powerlines.Clear();
	}

	public void AddTarget(TerrainPathConnect target)
	{
		InfrastructureType type = target.Type;
		if (!targets.ContainsKey(type))
		{
			targets.Add(type, new List<TerrainPathConnect>());
		}
		targets[type].Add(target);
	}

	public List<TerrainPathConnect> GetTargets(InfrastructureType type)
	{
		if (!targets.ContainsKey(type))
		{
			targets.Add(type, new List<TerrainPathConnect>());
		}
		return targets[type];
	}

	public void AddWire(PowerlineNode node)
	{
		string key = node.transform.root.name;
		if (!wires.ContainsKey(key))
		{
			wires.Add(key, new List<PowerlineNode>());
		}
		wires[key].Add(node);
	}

	public void CreateWires()
	{
		List<GameObject> list = new List<GameObject>();
		int num = 0;
		Material material = null;
		foreach (KeyValuePair<string, List<PowerlineNode>> wire in wires)
		{
			foreach (PowerlineNode item in wire.Value)
			{
				MegaWireConnectionHelper component = item.GetComponent<MegaWireConnectionHelper>();
				if (!component)
				{
					continue;
				}
				if (list.Count == 0)
				{
					material = item.WireMaterial;
					num = component.connections.Count;
				}
				else
				{
					GameObject gameObject = list[list.Count - 1];
					if (item.WireMaterial != material || component.connections.Count != num || (gameObject.transform.position - item.transform.position).sqrMagnitude > item.MaxDistance * item.MaxDistance)
					{
						CreateWire(wire.Key, list, material);
						list.Clear();
					}
				}
				list.Add(item.gameObject);
			}
			CreateWire(wire.Key, list, material);
			list.Clear();
		}
	}

	private void CreateWire(string name, List<GameObject> objects, Material material)
	{
		if (objects.Count >= 3 && material != null)
		{
			MegaWire megaWire = MegaWire.Create(null, objects, material, "Powerline Wires", null, 1f, 0.1f);
			if ((bool)megaWire)
			{
				megaWire.enabled = false;
				megaWire.RunPhysics(megaWire.warmPhysicsTime);
				GameObjectEx.SetHierarchyGroup(megaWire.gameObject, name);
			}
		}
	}
}
