using System.Collections.Generic;
using System.Threading.Tasks;
using ConVar;
using Steamworks;
using UnityEngine;

public class SteamStatistics
{
	private BasePlayer player;

	public Dictionary<string, int> intStats = new Dictionary<string, int>();

	private Task refresh;

	public SteamStatistics(BasePlayer p)
	{
		player = p;
	}

	public void Init()
	{
		if (SteamServer.IsValid)
		{
			refresh = SteamServerStats.RequestUserStats(player.userID);
			intStats.Clear();
		}
	}

	public void Save()
	{
		if (SteamServer.IsValid)
		{
			SteamServerStats.StoreUserStats(player.userID);
		}
	}

	public void Add(string name, int var)
	{
		if (!SteamServer.IsValid || refresh == null || !refresh.IsCompleted)
		{
			return;
		}
		using (TimeWarning.New("PlayerStats.Add"))
		{
			int value = 0;
			if (intStats.TryGetValue(name, out value))
			{
				intStats[name] += var;
				SteamServerStats.SetInt(player.userID, name, intStats[name]);
				return;
			}
			value = SteamServerStats.GetInt(player.userID, name);
			if (!SteamServerStats.SetInt(player.userID, name, value + var))
			{
				if (Global.developer > 0)
				{
					Debug.LogWarning("[STEAMWORKS] Couldn't SetUserStat: " + name);
				}
			}
			else
			{
				intStats.Add(name, value + var);
			}
		}
	}
}
