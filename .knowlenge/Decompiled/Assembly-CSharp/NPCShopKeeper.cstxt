using System.Collections.Generic;
using Facepunch;
using UnityEngine;

public class NPCShopKeeper : NPCPlayer
{
	private float greetDir;

	private Vector3 initialFacingDir;

	private BasePlayer lastWavedAtPlayer;

	public void OnDrawGizmos()
	{
		Gizmos.color = Color.green;
		Gizmos.DrawCube(base.transform.position + Vector3.up * 1f, new Vector3(0.5f, 1f, 0.5f));
	}

	public override void UpdateProtectionFromClothing()
	{
	}

	public override void Hurt(HitInfo info)
	{
	}

	public override void ServerInit()
	{
		base.ServerInit();
		initialFacingDir = base.transform.rotation * Vector3.forward;
		Invoke(DelayedSleepEnd, 3f);
		SetAimDirection(base.transform.rotation * Vector3.forward);
		InvokeRandomized(Greeting, Random.Range(5f, 10f), 5f, Random.Range(0f, 2f));
	}

	public override void PostServerLoad()
	{
		base.PostServerLoad();
	}

	public void DelayedSleepEnd()
	{
		EndSleeping();
	}

	public void Greeting()
	{
		List<BasePlayer> obj = Pool.GetList<BasePlayer>();
		Vis.Entities(base.transform.position, 10f, obj, 131072);
		Vector3 position = base.transform.position;
		BasePlayer basePlayer = null;
		foreach (BasePlayer item in obj)
		{
			if (item.isClient || item.IsNpc || item == this || !item.IsVisible(eyes.position) || item == lastWavedAtPlayer || Vector3.Dot(Vector3Ex.Direction2D(item.eyes.position, eyes.position), initialFacingDir) < 0.2f)
			{
				continue;
			}
			basePlayer = item;
			break;
		}
		if (basePlayer == null && !obj.Contains(lastWavedAtPlayer))
		{
			lastWavedAtPlayer = null;
		}
		if (basePlayer != null)
		{
			SignalBroadcast(Signal.Gesture, "wave");
			SetAimDirection(Vector3Ex.Direction2D(basePlayer.eyes.position, eyes.position));
			lastWavedAtPlayer = basePlayer;
		}
		else
		{
			SetAimDirection(initialFacingDir);
		}
		Pool.FreeList(ref obj);
	}
}
