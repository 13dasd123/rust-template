using System;
using Apex.Ai.HTN;
using Apex.Serialization;
using UnityEngine;

public abstract class MurdererBaseNavigateTo : OperatorBase<MurdererContext>
{
	[ApexSerialization]
	public bool RunUntilArrival = true;

	protected abstract Vector3 _GetDestination(MurdererContext context);

	protected virtual void OnPreStart(MurdererContext context)
	{
	}

	protected virtual void OnStart(MurdererContext context)
	{
	}

	protected virtual void OnPathFailed(MurdererContext context)
	{
	}

	protected virtual void OnPathComplete(MurdererContext context)
	{
	}

	public override void Execute(MurdererContext context)
	{
		OnPreStart(context);
		context.ReserveCoverPoint(null);
		context.Domain.SetDestination(_GetDestination(context));
		if (!RunUntilArrival)
		{
			context.OnWorldStateChangedEvent = (MurdererContext.WorldStateChangedEvent)Delegate.Combine(context.OnWorldStateChangedEvent, new MurdererContext.WorldStateChangedEvent(TrackWorldState));
		}
		OnStart(context);
	}

	protected void TrackWorldState(MurdererContext context, Facts fact, byte oldValue, byte newValue)
	{
		if (fact == Facts.PathStatus)
		{
			switch (newValue)
			{
			case 2:
				context.OnWorldStateChangedEvent = (MurdererContext.WorldStateChangedEvent)Delegate.Remove(context.OnWorldStateChangedEvent, new MurdererContext.WorldStateChangedEvent(TrackWorldState));
				MurdererIsNotNavigatingEffect.ApplyStatic(context, fromPlanner: false, temporary: false);
				ApplyExpectedEffects(context, context.CurrentTask);
				context.Domain.StopNavigating();
				OnPathComplete(context);
				break;
			case 3:
				context.OnWorldStateChangedEvent = (MurdererContext.WorldStateChangedEvent)Delegate.Remove(context.OnWorldStateChangedEvent, new MurdererContext.WorldStateChangedEvent(TrackWorldState));
				MurdererIsNotNavigatingEffect.ApplyStatic(context, fromPlanner: false, temporary: false);
				context.Domain.StopNavigating();
				OnPathFailed(context);
				break;
			}
		}
	}

	public override OperatorStateType Tick(MurdererContext context, PrimitiveTaskSelector task)
	{
		switch ((PathStatus)context.GetFact(Facts.PathStatus))
		{
		default:
			context.Domain.StopNavigating();
			OnPathFailed(context);
			return OperatorStateType.Aborted;
		case PathStatus.NoPath:
		case PathStatus.PathComplete:
			MurdererIsNotNavigatingEffect.ApplyStatic(context, fromPlanner: false, temporary: false);
			ApplyExpectedEffects(context, task);
			context.Domain.StopNavigating();
			OnPathComplete(context);
			return OperatorStateType.Complete;
		case PathStatus.PathRunning:
			if (RunUntilArrival)
			{
				return OperatorStateType.Running;
			}
			return OperatorStateType.Complete;
		}
	}

	public override void Abort(MurdererContext context, PrimitiveTaskSelector task)
	{
		MurdererIsNotNavigatingEffect.ApplyStatic(context, fromPlanner: false, temporary: false);
		context.Domain.StopNavigating();
	}
}
