using UnityEngine;

public class EgressState : BasicAIState
{
	private bool killing;

	private bool egressAltitueAchieved;

	public override bool CanInterrupt()
	{
		return false;
	}

	public override float GetWeight()
	{
		if (brain.GetEntity().OutOfCrates() && !brain.GetEntity().ShouldLand())
		{
			return 10000f;
		}
		CH47AIBrain component = brain.GetComponent<CH47AIBrain>();
		if (component != null)
		{
			if (!(component.age > 1800f))
			{
				return 0f;
			}
			return 10000f;
		}
		return 0f;
	}

	public override void StateEnter()
	{
		brain.GetEntity().EnableFacingOverride(enabled: false);
		Transform transform = brain.GetEntity().transform;
		Rigidbody rigidBody = brain.GetEntity().rigidBody;
		Vector3 rhs = ((rigidBody.velocity.magnitude < 0.1f) ? transform.forward : rigidBody.velocity.normalized);
		Vector3 vector = Vector3.Cross(Vector3.Cross(transform.up, rhs), Vector3.up);
		brain.mainInterestPoint = transform.position + vector * 8000f;
		brain.mainInterestPoint.y = 100f;
		brain.GetEntity().SetMoveTarget(brain.mainInterestPoint);
		base.StateEnter();
	}

	public override void StateThink(float delta)
	{
		base.StateThink(delta);
		if (killing)
		{
			return;
		}
		Vector3 position = brain.GetEntity().transform.position;
		if (position.y < 85f && !egressAltitueAchieved)
		{
			CH47LandingZone closest = CH47LandingZone.GetClosest(position);
			if (closest != null && Vector3Ex.Distance2D(closest.transform.position, position) < 20f)
			{
				float num = 0f;
				if (TerrainMeta.HeightMap != null && TerrainMeta.WaterMap != null)
				{
					num = Mathf.Max(TerrainMeta.WaterMap.GetHeight(position), TerrainMeta.HeightMap.GetHeight(position));
				}
				num += 100f;
				Vector3 moveTarget = position;
				moveTarget.y = num;
				brain.GetEntity().SetMoveTarget(moveTarget);
				return;
			}
		}
		egressAltitueAchieved = true;
		brain.GetEntity().SetMoveTarget(brain.mainInterestPoint);
		if (TimeInState() > 300f)
		{
			brain.GetEntity().Invoke("DelayedKill", 2f);
			killing = true;
		}
	}

	public override void StateLeave()
	{
		base.StateLeave();
	}
}
