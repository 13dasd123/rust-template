using System.Collections;
using Apex.Ai.HTN;
using Apex.Serialization;
using UnityEngine;

public class JunkpileUseMedicalTool : OperatorBase<ScientistJunkpileContext>
{
	[ApexSerialization]
	public HealthState Health;

	public override void Execute(ScientistJunkpileContext context)
	{
		context.Body.StartCoroutine(UseItem(context));
	}

	public override OperatorStateType Tick(ScientistJunkpileContext context, PrimitiveTaskSelector task)
	{
		if (context.IsFact(Facts.IsApplyingMedical))
		{
			return OperatorStateType.Running;
		}
		ApplyExpectedEffects(context, task);
		return OperatorStateType.Complete;
	}

	public override void Abort(ScientistJunkpileContext context, PrimitiveTaskSelector task)
	{
		context.SetFact(Facts.IsApplyingMedical, value: false);
		ItemType previousFact = (ItemType)context.GetPreviousFact(Facts.HeldItemType);
		JunkpileHoldItemOfType.SwitchToItem(context, previousFact);
	}

	private IEnumerator UseItem(ScientistJunkpileContext context)
	{
		Item item = context.Body.GetActiveItem();
		if (item != null)
		{
			MedicalTool tool = item.GetHeldEntity() as MedicalTool;
			if (tool != null)
			{
				context.SetFact(Facts.IsApplyingMedical, value: true);
				tool.ServerUse();
				if (Health == HealthState.FullHealth)
				{
					context.Body.Heal(context.Body.MaxHealth());
				}
				yield return CoroutineEx.waitForSeconds(tool.repeatDelay * 4f);
			}
		}
		context.SetFact(Facts.IsApplyingMedical, value: false);
		ItemType oldItem = (ItemType)context.GetPreviousFact(Facts.HeldItemType);
		JunkpileHoldItemOfType.SwitchToItem(context, oldItem);
	}
}
