using System;
using System.Text.RegularExpressions;
using Facepunch;
using GameAnalyticsSDK;
using GameAnalyticsSDK.Events;
using GameAnalyticsSDK.Net;
using GameAnalyticsSDK.Setup;
using GameAnalyticsSDK.State;
using GameAnalyticsSDK.Wrapper;
using UnityEngine;

[RequireComponent(typeof(GA_SpecialEvents))]
[ExecuteInEditMode]
public class GameAnalytics : MonoBehaviour
{
	private static Settings _settings;

	private static GameAnalyticsSDK.GameAnalytics _instance;

	private static bool _hasInitializeBeenCalled;

	public static Settings SettingsGA
	{
		get
		{
			if (_settings == null)
			{
				InitAPI();
			}
			return _settings;
		}
		private set
		{
			_settings = value;
		}
	}

	public static event Action OnCommandCenterUpdatedEvent;

	public void Awake()
	{
		if (UnityEngine.Application.isPlaying)
		{
			if (_instance != null)
			{
				Debug.LogWarning("Destroying duplicate GameAnalytics object - only one is allowed per scene!");
				UnityEngine.Object.Destroy(base.gameObject);
				return;
			}
			_instance = this;
			UnityEngine.Object.DontDestroyOnLoad(base.gameObject);
			UnityEngine.Application.logMessageReceived += GA_Debug.HandleLog;
			InternalInitialize();
		}
	}

	private void OnDestroy()
	{
		if (UnityEngine.Application.isPlaying && _instance == this)
		{
			_instance = null;
		}
	}

	private void OnApplicationQuit()
	{
		if (!SettingsGA.UseManualSessionHandling)
		{
			GameAnalyticsSDK.Net.GameAnalytics.OnStop();
		}
	}

	private static void InitAPI()
	{
		try
		{
			_settings = (Settings)Resources.Load("GameAnalytics/Settings", typeof(Settings));
			GameAnalyticsSDK.State.GAState.Init();
		}
		catch (Exception ex)
		{
			Debug.Log("Error getting Settings in InitAPI: " + ex.Message);
		}
	}

	private static void InternalInitialize()
	{
		if (UnityEngine.Application.isPlaying)
		{
			if (SettingsGA.InfoLogBuild)
			{
				GA_Setup.SetInfoLog(enabled: true);
			}
			if (SettingsGA.VerboseLogBuild)
			{
				GA_Setup.SetVerboseLog(enabled: true);
			}
			GA_Wrapper.SetUnitySdkVersion("unity " + Settings.VERSION);
			GA_Wrapper.SetUnityEngineVersion("unity " + GetUnityVersion());
			GA_Wrapper.SetBuild(BuildInfo.Current.Scm.ChangeId);
			if (SettingsGA.CustomDimensions01.Count > 0)
			{
				GA_Setup.SetAvailableCustomDimensions01(SettingsGA.CustomDimensions01);
			}
			if (SettingsGA.CustomDimensions02.Count > 0)
			{
				GA_Setup.SetAvailableCustomDimensions02(SettingsGA.CustomDimensions02);
			}
			if (SettingsGA.CustomDimensions03.Count > 0)
			{
				GA_Setup.SetAvailableCustomDimensions03(SettingsGA.CustomDimensions03);
			}
			if (SettingsGA.ResourceItemTypes.Count > 0)
			{
				GA_Setup.SetAvailableResourceItemTypes(SettingsGA.ResourceItemTypes);
			}
			if (SettingsGA.ResourceCurrencies.Count > 0)
			{
				GA_Setup.SetAvailableResourceCurrencies(SettingsGA.ResourceCurrencies);
			}
			if (SettingsGA.UseManualSessionHandling)
			{
				SetEnabledManualSessionHandling(enabled: true);
			}
		}
	}

	public static void Initialize()
	{
		if (UnityEngine.Application.isEditor)
		{
			_hasInitializeBeenCalled = true;
			return;
		}
		GA_Wrapper.Initialize("ab258be05882d64cb4e285ac8e8110f2", "e9e34daf4b7aff6505eccfc99eef811136b4c96c");
		_hasInitializeBeenCalled = true;
	}

	public static void NewBusinessEvent(string currency, int amount, string itemType, string itemId, string cartType)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Business.NewEvent(currency, amount, itemType, itemId, cartType, null);
		}
	}

	public static void NewDesignEvent(string eventName)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Design.NewEvent(eventName, null);
		}
	}

	public static void NewDesignEvent(string eventName, float eventValue)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Design.NewEvent(eventName, eventValue, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01, string progression02)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, progression02, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01, string progression02, string progression03)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, progression02, progression03, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01, int score)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, score, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01, string progression02, int score)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, progression02, score, null);
		}
	}

	public static void NewProgressionEvent(GAProgressionStatus progressionStatus, string progression01, string progression02, string progression03, int score)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Progression.NewEvent(progressionStatus, progression01, progression02, progression03, score, null);
		}
	}

	public static void NewResourceEvent(GAResourceFlowType flowType, string currency, float amount, string itemType, string itemId)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Resource.NewEvent(flowType, currency, amount, itemType, itemId, null);
		}
	}

	public static void NewErrorEvent(GAErrorSeverity severity, string message)
	{
		if (_hasInitializeBeenCalled)
		{
			GA_Error.NewEvent(severity, message, null);
		}
	}

	public static void SetFacebookId(string facebookId)
	{
		GA_Setup.SetFacebookId(facebookId);
	}

	public static void SetGender(GAGender gender)
	{
		GA_Setup.SetGender(gender);
	}

	public static void SetBirthYear(int birthYear)
	{
		GA_Setup.SetBirthYear(birthYear);
	}

	public static void SetCustomId(string userId)
	{
		GA_Wrapper.SetCustomUserId(userId);
	}

	public static void SetEnabledManualSessionHandling(bool enabled)
	{
		GA_Wrapper.SetEnabledManualSessionHandling(enabled);
	}

	public static void StartSession()
	{
		GA_Wrapper.StartSession();
	}

	public static void EndSession()
	{
		GA_Wrapper.EndSession();
	}

	public static void SetCustomDimension01(string customDimension)
	{
		GA_Setup.SetCustomDimension01(customDimension);
	}

	public static void SetCustomDimension02(string customDimension)
	{
		GA_Setup.SetCustomDimension02(customDimension);
	}

	public static void SetCustomDimension03(string customDimension)
	{
		GA_Setup.SetCustomDimension03(customDimension);
	}

	public void OnCommandCenterUpdated()
	{
		if (GameAnalyticsSDK.GameAnalytics.OnCommandCenterUpdatedEvent != null)
		{
			GameAnalyticsSDK.GameAnalytics.OnCommandCenterUpdatedEvent();
		}
	}

	public static void CommandCenterUpdated()
	{
		if (GameAnalyticsSDK.GameAnalytics.OnCommandCenterUpdatedEvent != null)
		{
			GameAnalyticsSDK.GameAnalytics.OnCommandCenterUpdatedEvent();
		}
	}

	public static string GetCommandCenterValueAsString(string key)
	{
		return GetCommandCenterValueAsString(key, null);
	}

	public static string GetCommandCenterValueAsString(string key, string defaultValue)
	{
		return GA_Wrapper.GetCommandCenterValueAsString(key, defaultValue);
	}

	public static bool IsCommandCenterReady()
	{
		return GA_Wrapper.IsCommandCenterReady();
	}

	public static string GetConfigurationsContentAsString()
	{
		return GA_Wrapper.GetConfigurationsContentAsString();
	}

	private static string GetUnityVersion()
	{
		string text = string.Empty;
		string[] array = UnityEngine.Application.unityVersion.Split('.');
		for (int i = 0; i < array.Length; i++)
		{
			if (int.TryParse(array[i], out var result))
			{
				text = ((i != 0) ? (text + "." + array[i]) : array[i]);
				continue;
			}
			string[] array2 = Regex.Split(array[i], "[^\\d]+");
			if (array2.Length > 0 && int.TryParse(array2[0], out result))
			{
				text = text + "." + array2[0];
			}
		}
		return text;
	}

	private static int GetPlatformIndex()
	{
		int num = -1;
		RuntimePlatform platform = UnityEngine.Application.platform;
		switch (platform)
		{
		case RuntimePlatform.IPhonePlayer:
			if (!SettingsGA.Platforms.Contains(platform))
			{
				return SettingsGA.Platforms.IndexOf(RuntimePlatform.tvOS);
			}
			return SettingsGA.Platforms.IndexOf(platform);
		case RuntimePlatform.tvOS:
			if (!SettingsGA.Platforms.Contains(platform))
			{
				return SettingsGA.Platforms.IndexOf(RuntimePlatform.IPhonePlayer);
			}
			return SettingsGA.Platforms.IndexOf(platform);
		default:
			if (platform != RuntimePlatform.MetroPlayerARM && platform != RuntimePlatform.MetroPlayerX64 && platform != RuntimePlatform.MetroPlayerX86)
			{
				return SettingsGA.Platforms.IndexOf(platform);
			}
			goto case RuntimePlatform.MetroPlayerX86;
		case RuntimePlatform.MetroPlayerX86:
		case RuntimePlatform.MetroPlayerX64:
		case RuntimePlatform.MetroPlayerARM:
			return SettingsGA.Platforms.IndexOf(RuntimePlatform.MetroPlayerARM);
		}
	}

	public static void SetBuildAllPlatforms(string build)
	{
		for (int i = 0; i < SettingsGA.Build.Count; i++)
		{
			SettingsGA.Build[i] = build;
		}
	}
}
