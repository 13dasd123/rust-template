using System;
using Apex.Ai.HTN;
using Apex.Serialization;
using UnityEngine;

public abstract class BaseNavigateTo : OperatorBase<BearContext>
{
	[ApexSerialization]
	public bool RunUntilArrival = true;

	protected abstract Vector3 _GetDestination(BearContext context);

	protected virtual void OnPreStart(BearContext context)
	{
	}

	protected virtual void OnStart(BearContext context)
	{
	}

	protected virtual void OnPathFailed(BearContext context)
	{
	}

	protected virtual void OnPathComplete(BearContext context)
	{
	}

	public override void Execute(BearContext context)
	{
		OnPreStart(context);
		context.Domain.SetDestination(_GetDestination(context));
		if (!RunUntilArrival)
		{
			context.OnWorldStateChangedEvent = (BearContext.WorldStateChangedEvent)Delegate.Combine(context.OnWorldStateChangedEvent, new BearContext.WorldStateChangedEvent(TrackWorldState));
		}
		OnStart(context);
	}

	private void TrackWorldState(BearContext context, Facts fact, byte oldValue, byte newValue)
	{
		if (fact == Facts.PathStatus)
		{
			switch (newValue)
			{
			case 2:
				context.OnWorldStateChangedEvent = (BearContext.WorldStateChangedEvent)Delegate.Remove(context.OnWorldStateChangedEvent, new BearContext.WorldStateChangedEvent(TrackWorldState));
				ApplyExpectedEffects(context, context.CurrentTask);
				context.Domain.StopNavigating();
				OnPathComplete(context);
				break;
			case 3:
				context.OnWorldStateChangedEvent = (BearContext.WorldStateChangedEvent)Delegate.Remove(context.OnWorldStateChangedEvent, new BearContext.WorldStateChangedEvent(TrackWorldState));
				context.Domain.StopNavigating();
				OnPathFailed(context);
				break;
			}
		}
	}

	public override OperatorStateType Tick(BearContext context, PrimitiveTaskSelector task)
	{
		switch ((PathStatus)context.GetFact(Facts.PathStatus))
		{
		default:
			context.Domain.StopNavigating();
			OnPathFailed(context);
			return OperatorStateType.Aborted;
		case PathStatus.NoPath:
		case PathStatus.PathComplete:
			ApplyExpectedEffects(context, task);
			context.Domain.StopNavigating();
			OnPathComplete(context);
			return OperatorStateType.Complete;
		case PathStatus.PathRunning:
			if (RunUntilArrival)
			{
				return OperatorStateType.Running;
			}
			return OperatorStateType.Complete;
		}
	}

	public override void Abort(BearContext context, PrimitiveTaskSelector task)
	{
		context.Domain.StopNavigating();
	}
}
