using System;
using System.Collections.Generic;
using System.IO;
using Newtonsoft.Json;
using Oxide.Core.Configuration;

public class DataFileSystem
{
	private readonly Dictionary<string, DynamicConfigFile> _datafiles;

	private readonly JsonSerializerSettings _settings;

	public string Directory { get; private set; }

	public DataFileSystem(string directory)
	{
		Directory = directory;
		_datafiles = new Dictionary<string, DynamicConfigFile>();
		KeyValuesConverter item = new KeyValuesConverter();
		_settings = new JsonSerializerSettings();
		_settings.Converters.Add(item);
	}

	public DynamicConfigFile GetFile(string name)
	{
		name = DynamicConfigFile.SanitiseName(name);
		if (_datafiles.TryGetValue(name, out var value))
		{
			return value;
		}
		value = new DynamicConfigFile(Path.Combine(Directory, $"{name}.json"));
		_datafiles.Add(name, value);
		return value;
	}

	public bool ExistsDatafile(string name)
	{
		return GetFile(name).Exists();
	}

	public DynamicConfigFile GetDatafile(string name)
	{
		DynamicConfigFile file = GetFile(name);
		if (file.Exists())
		{
			file.Load();
		}
		else
		{
			file.Save();
		}
		return file;
	}

	public void SaveDatafile(string name)
	{
		GetFile(name).Save();
	}

	public T ReadObject<T>(string name)
	{
		if (ExistsDatafile(name))
		{
			return GetFile(name).ReadObject<T>();
		}
		T val = Activator.CreateInstance<T>();
		WriteObject(name, val);
		return val;
	}

	public void WriteObject<T>(string name, T Object, bool sync = false)
	{
		GetFile(name).WriteObject(Object, sync);
	}
}
