using System.Collections.Generic;

public static class ArrayPool
{
	private const int MaxArrayLength = 50;

	private const int InitialPoolAmount = 64;

	private const int MaxPoolAmount = 256;

	private static List<Queue<object[]>> _pooledArrays;

	static ArrayPool()
	{
		_pooledArrays = new List<Queue<object[]>>();
		for (int i = 0; i < 50; i++)
		{
			_pooledArrays.Add(new Queue<object[]>());
			SetupArrays(i + 1);
		}
	}

	public static object[] Get(int length)
	{
		if (length == 0 || length > 50)
		{
			return new object[length];
		}
		Queue<object[]> queue = _pooledArrays[length - 1];
		lock (queue)
		{
			if (queue.Count == 0)
			{
				SetupArrays(length);
			}
			return queue.Dequeue();
		}
	}

	public static void Free(object[] array)
	{
		if (array == null || array.Length == 0 || array.Length > 50)
		{
			return;
		}
		for (int i = 0; i < array.Length; i++)
		{
			array[i] = null;
		}
		Queue<object[]> queue = _pooledArrays[array.Length - 1];
		lock (queue)
		{
			if (queue.Count > 256)
			{
				for (int j = 0; j < 64; j++)
				{
					queue.Dequeue();
				}
			}
			else
			{
				queue.Enqueue(array);
			}
		}
	}

	private static void SetupArrays(int length)
	{
		Queue<object[]> queue = _pooledArrays[length - 1];
		for (int i = 0; i < 64; i++)
		{
			queue.Enqueue(new object[length]);
		}
	}
}
