using UnityEngine;

[ExecuteInEditMode]
[AddComponentMenu("Mega Wire/Attach")]
public class MegaWireAttach : MonoBehaviour
{
	public MegaWire wire;

	public int span;

	public int connection;

	public float alpha;

	public Vector3 offset = Vector3.zero;

	public bool align;

	public Vector3 rotate = Vector3.zero;

	private Quaternion locrot = Quaternion.identity;

	private Matrix4x4 wtm;

	public Transform parent;

	private void LateUpdate()
	{
		if (wire == null && parent != null)
		{
			wire = parent.GetComponentInChildren<MegaWire>();
		}
		if ((bool)wire)
		{
			float num = Mathf.Clamp(alpha, 0f, 0.9999f);
			float num2 = num * (float)wire.spans.Count;
			int num3 = (int)num2;
			float num4 = num2 - (float)num3;
			MegaWireSpan megaWireSpan = wire.spans[num3];
			MegaWireConnection megaWireConnection = megaWireSpan.connections[connection];
			Vector3 vector = megaWireConnection.Interp(num4);
			base.transform.position = vector + offset;
			if (align)
			{
				Vector3 vector2 = megaWireConnection.Interp(num4 + 0.001f);
				Vector3 forward = vector2 - vector;
				Quaternion q = (locrot = Quaternion.LookRotation(forward, Vector3.up));
				wtm.SetTRS(vector, q, Vector3.one);
				Quaternion quaternion = Quaternion.Euler(rotate);
				base.transform.rotation = locrot * quaternion;
			}
		}
	}
}
