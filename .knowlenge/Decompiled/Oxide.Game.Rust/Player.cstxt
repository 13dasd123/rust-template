using System;
using System.Collections.Generic;
using System.Globalization;
using System.Text.RegularExpressions;
using Network;
using Oxide.Core.Libraries;
using Oxide.Game.Rust.Libraries;
using UnityEngine;

public class Player : Library
{
	private static string ipPattern = ":{1}[0-9]{1}\\d*";

	public List<BasePlayer> Players => BasePlayer.activePlayerList;

	public List<BasePlayer> Sleepers => BasePlayer.sleepingPlayerList;

	public CultureInfo Language(BasePlayer player)
	{
		return CultureInfo.GetCultureInfo(player.net.connection.info.GetString("global.language") ?? "en");
	}

	public string Address(Connection connection)
	{
		return Regex.Replace(connection.ipaddress, ipPattern, "");
	}

	public string Address(BasePlayer player)
	{
		if (player?.net?.connection == null)
		{
			return null;
		}
		return Address(player.net.connection);
	}

	public int Ping(Connection connection)
	{
		return Net.sv.GetAveragePing(connection);
	}

	public int Ping(BasePlayer player)
	{
		return Ping(player.net.connection);
	}

	public bool IsAdmin(ulong id)
	{
		return ServerUsers.Is(id, ServerUsers.UserGroup.Owner);
	}

	public bool IsAdmin(string id)
	{
		return IsAdmin(Convert.ToUInt64(id));
	}

	public bool IsAdmin(BasePlayer player)
	{
		return IsAdmin(player.userID);
	}

	public bool IsBanned(ulong id)
	{
		return ServerUsers.Is(id, ServerUsers.UserGroup.Banned);
	}

	public bool IsBanned(string id)
	{
		return IsBanned(Convert.ToUInt64(id));
	}

	public bool IsBanned(BasePlayer player)
	{
		return IsBanned(player.userID);
	}

	public bool IsConnected(BasePlayer player)
	{
		return BasePlayer.activePlayerList.Contains(player);
	}

	public bool IsSleeping(ulong id)
	{
		return BasePlayer.FindSleeping(id);
	}

	public bool IsSleeping(string id)
	{
		return IsSleeping(Convert.ToUInt64(id));
	}

	public bool IsSleeping(BasePlayer player)
	{
		return IsSleeping(player.userID);
	}

	public void Ban(ulong id, string reason = "")
	{
		if (!IsBanned(id))
		{
			BasePlayer basePlayer = FindById(id);
			ServerUsers.Set(id, ServerUsers.UserGroup.Banned, basePlayer?.displayName ?? "Unknown", reason);
			ServerUsers.Save();
			if (basePlayer != null && IsConnected(basePlayer))
			{
				Kick(basePlayer, reason);
			}
		}
	}

	public void Ban(string id, string reason = "")
	{
		Ban(Convert.ToUInt64(id), reason);
	}

	public void Ban(BasePlayer player, string reason = "")
	{
		Ban(player.UserIDString, reason);
	}

	public void Heal(BasePlayer player, float amount)
	{
		player.Heal(amount);
	}

	public void Hurt(BasePlayer player, float amount)
	{
		player.Hurt(amount);
	}

	public void Kick(BasePlayer player, string reason = "")
	{
		player.Kick(reason);
	}

	public void Kill(BasePlayer player)
	{
		player.Die();
	}

	public void Teleport(BasePlayer player, Vector3 destination)
	{
		if (!player.IsSpectating())
		{
			player.MovePosition(destination);
			player.ClientRPCPlayer(null, player, "ForcePositionTo", destination);
		}
	}

	public void Teleport(BasePlayer player, BasePlayer target)
	{
		Teleport(player, Position(target));
	}

	public void Teleport(BasePlayer player, float x, float y, float z)
	{
		Teleport(player, new Vector3(x, y, z));
	}

	public void Unban(ulong id)
	{
		if (IsBanned(id))
		{
			ServerUsers.Remove(id);
			ServerUsers.Save();
		}
	}

	public void Unban(string id)
	{
		Unban(Convert.ToUInt64(id));
	}

	public void Unban(BasePlayer player)
	{
		Unban(player.userID);
	}

	public Vector3 Position(BasePlayer player)
	{
		return player.transform.position;
	}

	public BasePlayer Find(string nameOrIdOrIp)
	{
		foreach (BasePlayer player in Players)
		{
			if (nameOrIdOrIp.Equals(player.displayName, StringComparison.OrdinalIgnoreCase) || nameOrIdOrIp.Equals(player.UserIDString) || nameOrIdOrIp.Equals(player.net.connection.ipaddress))
			{
				return player;
			}
		}
		return null;
	}

	public BasePlayer FindById(string id)
	{
		foreach (BasePlayer player in Players)
		{
			if (id.Equals(player.UserIDString))
			{
				return player;
			}
		}
		return null;
	}

	public BasePlayer FindById(ulong id)
	{
		foreach (BasePlayer player in Players)
		{
			if (id.Equals(player.userID))
			{
				return player;
			}
		}
		return null;
	}

	public void Command(BasePlayer player, string command, params object[] args)
	{
		player.SendConsoleCommand(command, args);
	}

	public void Message(BasePlayer player, string message, string prefix = null, ulong userId = 0uL)
	{
		player.SendConsoleCommand("chat.add", userId, (prefix != null) ? $"{prefix} {message}" : message, 1.0);
	}

	public void Message(BasePlayer player, string message, string prefix = null, ulong userId = 0uL, params object[] args)
	{
		Message(player, string.Format(message, args), prefix, 0uL);
	}

	public void Reply(BasePlayer player, string message, string prefix = null, ulong userId = 0uL)
	{
		Message(player, message, prefix, 0uL);
	}

	public void Reply(BasePlayer player, string message, string prefix = null, ulong userId = 0uL, params object[] args)
	{
		Reply(player, string.Format(message, args), prefix, 0uL);
	}

	public void DropItem(BasePlayer player, int itemId)
	{
		Vector3 position = player.transform.position;
		PlayerInventory playerInventory = Inventory(player);
		for (int i = 0; i < playerInventory.containerMain.capacity; i++)
		{
			Item slot = playerInventory.containerMain.GetSlot(i);
			if (slot.info.itemid == itemId)
			{
				slot.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
		for (int j = 0; j < playerInventory.containerBelt.capacity; j++)
		{
			Item slot2 = playerInventory.containerBelt.GetSlot(j);
			if (slot2.info.itemid == itemId)
			{
				slot2.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
		for (int k = 0; k < playerInventory.containerWear.capacity; k++)
		{
			Item slot3 = playerInventory.containerWear.GetSlot(k);
			if (slot3.info.itemid == itemId)
			{
				slot3.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
	}

	public void DropItem(BasePlayer player, Item item)
	{
		Vector3 position = player.transform.position;
		PlayerInventory playerInventory = Inventory(player);
		for (int i = 0; i < playerInventory.containerMain.capacity; i++)
		{
			Item slot = playerInventory.containerMain.GetSlot(i);
			if (slot == item)
			{
				slot.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
		for (int j = 0; j < playerInventory.containerBelt.capacity; j++)
		{
			Item slot2 = playerInventory.containerBelt.GetSlot(j);
			if (slot2 == item)
			{
				slot2.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
		for (int k = 0; k < playerInventory.containerWear.capacity; k++)
		{
			Item slot3 = playerInventory.containerWear.GetSlot(k);
			if (slot3 == item)
			{
				slot3.Drop(position + new Vector3(0f, 1f, 0f) + position / 2f, (position + new Vector3(0f, 0.2f, 0f)) * 8f);
			}
		}
	}

	public void GiveItem(BasePlayer player, int itemId, int quantity = 1)
	{
		GiveItem(player, Oxide.Game.Rust.Libraries.Item.GetItem(itemId), quantity);
	}

	public void GiveItem(BasePlayer player, Item item, int quantity = 1)
	{
		player.inventory.GiveItem(ItemManager.CreateByItemID(item.info.itemid, quantity, 0uL));
	}

	public PlayerInventory Inventory(BasePlayer player)
	{
		return player.inventory;
	}

	public void ClearInventory(BasePlayer player)
	{
		Inventory(player)?.DoDestroy();
	}
}
