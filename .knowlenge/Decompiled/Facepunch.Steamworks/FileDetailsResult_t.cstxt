using System;
using System.Runtime.InteropServices;
using Facepunch.Steamworks;
using SteamNative;

[StructLayout(LayoutKind.Sequential, Pack = 8)]
internal struct FileDetailsResult_t
{
	[StructLayout(LayoutKind.Sequential, Pack = 4)]
	internal struct PackSmall
	{
		internal Result Result;

		internal ulong FileSize;

		[MarshalAs(UnmanagedType.ByValTStr, SizeConst = 20)]
		internal char FileSHA;

		internal uint Flags;

		public static implicit operator FileDetailsResult_t(PackSmall d)
		{
			FileDetailsResult_t result = default(FileDetailsResult_t);
			result.Result = d.Result;
			result.FileSize = d.FileSize;
			result.FileSHA = d.FileSHA;
			result.Flags = d.Flags;
			return result;
		}
	}

	internal const int CallbackId = 1023;

	internal Result Result;

	internal ulong FileSize;

	[MarshalAs(UnmanagedType.ByValTStr, SizeConst = 20)]
	internal char FileSHA;

	internal uint Flags;

	internal static FileDetailsResult_t FromPointer(IntPtr p)
	{
		if (Platform.PackSmall)
		{
			return (PackSmall)Marshal.PtrToStructure(p, typeof(PackSmall));
		}
		return (FileDetailsResult_t)Marshal.PtrToStructure(p, typeof(FileDetailsResult_t));
	}

	internal static int StructSize()
	{
		if (Platform.PackSmall)
		{
			return Marshal.SizeOf(typeof(PackSmall));
		}
		return Marshal.SizeOf(typeof(FileDetailsResult_t));
	}

	internal static CallResult<FileDetailsResult_t> CallResult(BaseSteamworks steamworks, SteamAPICall_t call, Action<FileDetailsResult_t, bool> CallbackFunction)
	{
		return new CallResult<FileDetailsResult_t>(steamworks, call, CallbackFunction, FromPointer, StructSize(), 1023);
	}

	internal static void Register(BaseSteamworks steamworks)
	{
		CallbackHandle callbackHandle = new CallbackHandle(steamworks);
		if (Config.UseThisCall)
		{
			if (Platform.IsWindows)
			{
				callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableWinThis)));
				Callback.VTableWinThis vTableWinThis = new Callback.VTableWinThis
				{
					ResultA = OnResultThis,
					ResultB = OnResultWithInfoThis,
					GetSize = OnGetSizeThis
				};
				callbackHandle.FuncA = GCHandle.Alloc(vTableWinThis.ResultA);
				callbackHandle.FuncB = GCHandle.Alloc(vTableWinThis.ResultB);
				callbackHandle.FuncC = GCHandle.Alloc(vTableWinThis.GetSize);
				Marshal.StructureToPtr((object)vTableWinThis, callbackHandle.vTablePtr, fDeleteOld: false);
			}
			else
			{
				callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableThis)));
				Callback.VTableThis vTableThis = new Callback.VTableThis
				{
					ResultA = OnResultThis,
					ResultB = OnResultWithInfoThis,
					GetSize = OnGetSizeThis
				};
				callbackHandle.FuncA = GCHandle.Alloc(vTableThis.ResultA);
				callbackHandle.FuncB = GCHandle.Alloc(vTableThis.ResultB);
				callbackHandle.FuncC = GCHandle.Alloc(vTableThis.GetSize);
				Marshal.StructureToPtr((object)vTableThis, callbackHandle.vTablePtr, fDeleteOld: false);
			}
		}
		else if (Platform.IsWindows)
		{
			callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableWin)));
			Callback.VTableWin vTableWin = new Callback.VTableWin
			{
				ResultA = OnResult,
				ResultB = OnResultWithInfo,
				GetSize = OnGetSize
			};
			callbackHandle.FuncA = GCHandle.Alloc(vTableWin.ResultA);
			callbackHandle.FuncB = GCHandle.Alloc(vTableWin.ResultB);
			callbackHandle.FuncC = GCHandle.Alloc(vTableWin.GetSize);
			Marshal.StructureToPtr((object)vTableWin, callbackHandle.vTablePtr, fDeleteOld: false);
		}
		else
		{
			callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTable)));
			Callback.VTable vTable = new Callback.VTable
			{
				ResultA = OnResult,
				ResultB = OnResultWithInfo,
				GetSize = OnGetSize
			};
			callbackHandle.FuncA = GCHandle.Alloc(vTable.ResultA);
			callbackHandle.FuncB = GCHandle.Alloc(vTable.ResultB);
			callbackHandle.FuncC = GCHandle.Alloc(vTable.GetSize);
			Marshal.StructureToPtr((object)vTable, callbackHandle.vTablePtr, fDeleteOld: false);
		}
		Callback callback = new Callback();
		callback.vTablePtr = callbackHandle.vTablePtr;
		callback.CallbackFlags = (byte)(steamworks.IsGameServer ? 2 : 0);
		callback.CallbackId = 1023;
		callbackHandle.PinnedCallback = GCHandle.Alloc(callback, GCHandleType.Pinned);
		steamworks.native.api.SteamAPI_RegisterCallback(callbackHandle.PinnedCallback.AddrOfPinnedObject(), 1023);
		steamworks.RegisterCallbackHandle(callbackHandle);
	}

	[MonoPInvokeCallback]
	internal static void OnResultThis(IntPtr self, IntPtr param)
	{
		OnResult(param);
	}

	[MonoPInvokeCallback]
	internal static void OnResultWithInfoThis(IntPtr self, IntPtr param, bool failure, SteamAPICall_t call)
	{
		OnResultWithInfo(param, failure, call);
	}

	[MonoPInvokeCallback]
	internal static int OnGetSizeThis(IntPtr self)
	{
		return OnGetSize();
	}

	[MonoPInvokeCallback]
	internal static int OnGetSize()
	{
		return StructSize();
	}

	[MonoPInvokeCallback]
	internal static void OnResult(IntPtr param)
	{
		OnResultWithInfo(param, failure: false, 0uL);
	}

	[MonoPInvokeCallback]
	internal static void OnResultWithInfo(IntPtr param, bool failure, SteamAPICall_t call)
	{
		if (!failure)
		{
			FileDetailsResult_t data = FromPointer(param);
			if (Client.Instance != null)
			{
				Client.Instance.OnCallback(data);
			}
			if (Server.Instance != null)
			{
				Server.Instance.OnCallback(data);
			}
		}
	}
}
