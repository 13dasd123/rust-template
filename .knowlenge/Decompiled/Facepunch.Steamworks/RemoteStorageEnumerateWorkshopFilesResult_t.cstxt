using System;
using System.Runtime.InteropServices;
using Facepunch.Steamworks;
using SteamNative;

[StructLayout(LayoutKind.Sequential, Pack = 8)]
internal struct RemoteStorageEnumerateWorkshopFilesResult_t
{
	[StructLayout(LayoutKind.Sequential, Pack = 4)]
	internal struct PackSmall
	{
		internal Result Result;

		internal int ResultsReturned;

		internal int TotalResultCount;

		[MarshalAs(UnmanagedType.ByValArray, SizeConst = 50, ArraySubType = UnmanagedType.U8)]
		internal ulong[] GPublishedFileId;

		[MarshalAs(UnmanagedType.ByValArray, SizeConst = 50, ArraySubType = UnmanagedType.R4)]
		internal float[] GScore;

		internal uint AppId;

		internal uint StartIndex;

		public static implicit operator RemoteStorageEnumerateWorkshopFilesResult_t(PackSmall d)
		{
			RemoteStorageEnumerateWorkshopFilesResult_t result = default(RemoteStorageEnumerateWorkshopFilesResult_t);
			result.Result = d.Result;
			result.ResultsReturned = d.ResultsReturned;
			result.TotalResultCount = d.TotalResultCount;
			result.GPublishedFileId = d.GPublishedFileId;
			result.GScore = d.GScore;
			result.AppId = d.AppId;
			result.StartIndex = d.StartIndex;
			return result;
		}
	}

	internal const int CallbackId = 1319;

	internal Result Result;

	internal int ResultsReturned;

	internal int TotalResultCount;

	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 50, ArraySubType = UnmanagedType.U8)]
	internal ulong[] GPublishedFileId;

	[MarshalAs(UnmanagedType.ByValArray, SizeConst = 50, ArraySubType = UnmanagedType.R4)]
	internal float[] GScore;

	internal uint AppId;

	internal uint StartIndex;

	internal static RemoteStorageEnumerateWorkshopFilesResult_t FromPointer(IntPtr p)
	{
		if (Platform.PackSmall)
		{
			return (PackSmall)Marshal.PtrToStructure(p, typeof(PackSmall));
		}
		return (RemoteStorageEnumerateWorkshopFilesResult_t)Marshal.PtrToStructure(p, typeof(RemoteStorageEnumerateWorkshopFilesResult_t));
	}

	internal static int StructSize()
	{
		if (Platform.PackSmall)
		{
			return Marshal.SizeOf(typeof(PackSmall));
		}
		return Marshal.SizeOf(typeof(RemoteStorageEnumerateWorkshopFilesResult_t));
	}

	internal static CallResult<RemoteStorageEnumerateWorkshopFilesResult_t> CallResult(BaseSteamworks steamworks, SteamAPICall_t call, Action<RemoteStorageEnumerateWorkshopFilesResult_t, bool> CallbackFunction)
	{
		return new CallResult<RemoteStorageEnumerateWorkshopFilesResult_t>(steamworks, call, CallbackFunction, FromPointer, StructSize(), 1319);
	}

	internal static void Register(BaseSteamworks steamworks)
	{
		CallbackHandle callbackHandle = new CallbackHandle(steamworks);
		if (Config.UseThisCall)
		{
			if (Platform.IsWindows)
			{
				callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableWinThis)));
				Callback.VTableWinThis vTableWinThis = new Callback.VTableWinThis
				{
					ResultA = OnResultThis,
					ResultB = OnResultWithInfoThis,
					GetSize = OnGetSizeThis
				};
				callbackHandle.FuncA = GCHandle.Alloc(vTableWinThis.ResultA);
				callbackHandle.FuncB = GCHandle.Alloc(vTableWinThis.ResultB);
				callbackHandle.FuncC = GCHandle.Alloc(vTableWinThis.GetSize);
				Marshal.StructureToPtr((object)vTableWinThis, callbackHandle.vTablePtr, fDeleteOld: false);
			}
			else
			{
				callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableThis)));
				Callback.VTableThis vTableThis = new Callback.VTableThis
				{
					ResultA = OnResultThis,
					ResultB = OnResultWithInfoThis,
					GetSize = OnGetSizeThis
				};
				callbackHandle.FuncA = GCHandle.Alloc(vTableThis.ResultA);
				callbackHandle.FuncB = GCHandle.Alloc(vTableThis.ResultB);
				callbackHandle.FuncC = GCHandle.Alloc(vTableThis.GetSize);
				Marshal.StructureToPtr((object)vTableThis, callbackHandle.vTablePtr, fDeleteOld: false);
			}
		}
		else if (Platform.IsWindows)
		{
			callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTableWin)));
			Callback.VTableWin vTableWin = new Callback.VTableWin
			{
				ResultA = OnResult,
				ResultB = OnResultWithInfo,
				GetSize = OnGetSize
			};
			callbackHandle.FuncA = GCHandle.Alloc(vTableWin.ResultA);
			callbackHandle.FuncB = GCHandle.Alloc(vTableWin.ResultB);
			callbackHandle.FuncC = GCHandle.Alloc(vTableWin.GetSize);
			Marshal.StructureToPtr((object)vTableWin, callbackHandle.vTablePtr, fDeleteOld: false);
		}
		else
		{
			callbackHandle.vTablePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(Callback.VTable)));
			Callback.VTable vTable = new Callback.VTable
			{
				ResultA = OnResult,
				ResultB = OnResultWithInfo,
				GetSize = OnGetSize
			};
			callbackHandle.FuncA = GCHandle.Alloc(vTable.ResultA);
			callbackHandle.FuncB = GCHandle.Alloc(vTable.ResultB);
			callbackHandle.FuncC = GCHandle.Alloc(vTable.GetSize);
			Marshal.StructureToPtr((object)vTable, callbackHandle.vTablePtr, fDeleteOld: false);
		}
		Callback callback = new Callback();
		callback.vTablePtr = callbackHandle.vTablePtr;
		callback.CallbackFlags = (byte)(steamworks.IsGameServer ? 2 : 0);
		callback.CallbackId = 1319;
		callbackHandle.PinnedCallback = GCHandle.Alloc(callback, GCHandleType.Pinned);
		steamworks.native.api.SteamAPI_RegisterCallback(callbackHandle.PinnedCallback.AddrOfPinnedObject(), 1319);
		steamworks.RegisterCallbackHandle(callbackHandle);
	}

	[MonoPInvokeCallback]
	internal static void OnResultThis(IntPtr self, IntPtr param)
	{
		OnResult(param);
	}

	[MonoPInvokeCallback]
	internal static void OnResultWithInfoThis(IntPtr self, IntPtr param, bool failure, SteamAPICall_t call)
	{
		OnResultWithInfo(param, failure, call);
	}

	[MonoPInvokeCallback]
	internal static int OnGetSizeThis(IntPtr self)
	{
		return OnGetSize();
	}

	[MonoPInvokeCallback]
	internal static int OnGetSize()
	{
		return StructSize();
	}

	[MonoPInvokeCallback]
	internal static void OnResult(IntPtr param)
	{
		OnResultWithInfo(param, failure: false, 0uL);
	}

	[MonoPInvokeCallback]
	internal static void OnResultWithInfo(IntPtr param, bool failure, SteamAPICall_t call)
	{
		if (!failure)
		{
			RemoteStorageEnumerateWorkshopFilesResult_t data = FromPointer(param);
			if (Client.Instance != null)
			{
				Client.Instance.OnCallback(data);
			}
			if (Server.Instance != null)
			{
				Server.Instance.OnCallback(data);
			}
		}
	}
}
