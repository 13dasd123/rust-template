using System;
using System.Collections.Generic;
using Newtonsoft.Json;
using Oxide.Ext.Discord;
using Oxide.Ext.Discord.Json;
using Oxide.Ext.Discord.Libraries;
using Oxide.Ext.Discord.Logging;

[JsonConverter(typeof(DiscordLocaleConverter))]
public readonly struct DiscordLocale : IEquatable<DiscordLocale>
{
	public readonly string Id;

	private static DateTime _lastError;

	private static readonly List<string> LocaleError = new List<string>();

	public bool IsValid => !string.IsNullOrEmpty(Id);

	public ServerLocale GetServerLocale()
	{
		return BaseDiscordLibrary<DiscordLocales>.Instance.GetServerLanguage(this);
	}

	private DiscordLocale(string id)
	{
		Id = id;
	}

	public static DiscordLocale Parse(string locale)
	{
		DiscordLocale discordLocale = new DiscordLocale(locale);
		if (!BaseDiscordLibrary<DiscordLocales>.Instance.Contains(discordLocale) && (!LocaleError.Contains(locale) || _lastError + TimeSpan.FromMinutes(5.0) < DateTime.UtcNow))
		{
			LocaleError.Remove(locale);
			LocaleError.Add(locale);
			_lastError = DateTime.UtcNow;
			DiscordExtension.GlobalLogger.Warning("Parsed DiscordLocale '{0}' which does not exist in DiscordLang. Please give this message to the Discord Extension Authors", locale);
		}
		return discordLocale;
	}

	internal static DiscordLocale Create(string locale)
	{
		return new DiscordLocale(locale);
	}

	public override string ToString()
	{
		return Id;
	}

	public bool Equals(DiscordLocale other)
	{
		return Id == other.Id;
	}

	public override bool Equals(object obj)
	{
		return obj is DiscordLocale other && Equals(other);
	}

	public override int GetHashCode()
	{
		return (Id != null) ? Id.GetHashCode() : 0;
	}
}
