using System.Collections.Generic;
using Newtonsoft.Json;
using Oxide.Ext.Discord.Entities;
using Oxide.Ext.Discord.Exceptions;
using Oxide.Ext.Discord.Interfaces;

public abstract class BaseMessageCreate : IFileAttachments, IDiscordValidation, IDiscordMessageTemplate
{
	[JsonProperty("content")]
	public string Content { get; set; }

	[JsonProperty("tts")]
	public bool? Tts { get; set; }

	[JsonProperty("embeds")]
	public List<DiscordEmbed> Embeds { get; set; }

	[JsonProperty("allowed_mentions")]
	public AllowedMentions AllowedMentions { get; set; }

	[JsonProperty("components")]
	public List<ActionRowComponent> Components { get; set; }

	[JsonProperty("sticker_ids")]
	public List<Snowflake> StickerIds { get; set; }

	[JsonProperty("flags")]
	public MessageFlags? Flags { get; set; }

	[JsonProperty("poll")]
	public PollCreate Poll { get; set; }

	public List<MessageFileAttachment> FileAttachments { get; set; }

	[JsonProperty("attachments")]
	public List<MessageAttachment> Attachments { get; set; }

	public void AddAttachment(string filename, byte[] data, string contentType, string description = null, string title = null)
	{
		InvalidFileNameException.ThrowIfInvalid(filename);
		InvalidMessageException.ThrowIfInvalidAttachmentDescription(description);
		if (FileAttachments == null)
		{
			FileAttachments = new List<MessageFileAttachment>();
		}
		if (Attachments == null)
		{
			Attachments = new List<MessageAttachment>();
		}
		FileAttachments.Add(new MessageFileAttachment(filename, data, contentType));
		Attachments.Add(new MessageAttachment
		{
			Id = new Snowflake((ulong)FileAttachments.Count),
			Filename = filename,
			Description = description,
			Title = title
		});
	}

	public void Validate()
	{
		ValidateRequiredFields();
		InvalidMessageException.ThrowIfInvalidContent(Content);
		ValidateFlags();
		if (Components != null)
		{
			for (int i = 0; i < Components.Count; i++)
			{
				ActionRowComponent actionRowComponent = Components[i];
				actionRowComponent.Validate();
			}
		}
	}

	protected virtual void ValidateRequiredFields()
	{
		InvalidMessageException.ThrowIfMissingRequiredField(this);
	}

	protected virtual void ValidateFlags()
	{
		InvalidMessageException.ThrowIfInvalidFlags(Flags, MessageFlags.SuppressEmbeds | MessageFlags.SuppressNotifications, "Invalid Message Flags Used for Channel Message. Only supported flags are MessageFlags.SuppressEmbeds or MessageFlags.SuppressNotifications");
	}
}
