using System;
using System.Collections;
using System.Collections.Generic;
using Facepunch;
using Facepunch.Models.Analytics;
using Newtonsoft.Json;
using UnityEngine;

public class Analytics
{
	private static Stat Stats = new Stat();

	internal string Uid { get; set; }

	internal string SessionId { get; private set; }

	internal string ReportUrl { get; private set; }

	public static DateTime LastSend { get; internal set; }

	public static string LastMessage { get; internal set; } = string.Empty;

	public static string LastResponse { get; internal set; } = string.Empty;

	internal Analytics(string reportUrl)
	{
		Uid = Facepunch.Application.Integration.UserId;
		ReportUrl = reportUrl;
		SessionId = Guid.NewGuid().ToString();
		SessionStart obj = new SessionStart
		{
			Uid = Uid,
			Sid = SessionId,
			ChangeSet = BuildInfo.Current.Scm.ChangeId,
			Branch = BuildInfo.Current.Scm.Branch,
			Os = SystemInfo.operatingSystem,
			Bucket = Facepunch.Application.Integration.Bucket,
			Gpu = SystemInfo.graphicsDeviceName,
			Cpu = SystemInfo.processorType,
			CpuFrq = SystemInfo.processorFrequency,
			CpuCnt = SystemInfo.processorCount,
			Mem = SystemInfo.systemMemorySize,
			GpuMem = SystemInfo.graphicsMemorySize,
			Arch = ((IntPtr.Size != 4) ? "x64" : "x86"),
			Width = Screen.width,
			Height = Screen.height,
			Fullscreen = Screen.fullScreen,
			RR = Screen.currentResolution.refreshRate
		};
		Send("start", obj);
		Facepunch.Application.Controller.StartCoroutine(KeepAlive());
	}

	internal void OnQuit()
	{
		SendSessionUpdate();
		SessionClose sessionClose = new SessionClose();
		sessionClose.Uid = Uid;
		sessionClose.Sid = SessionId;
		sessionClose.FinalUpdate = new SessionUpdate
		{
			Frames = Performance.CategorizedFrameCount,
			Mem = Performance.MemoryUsage,
			Gc = Performance.GarbageCollections
		};
		SessionClose obj = sessionClose;
		Send("close", obj, andWait: true);
	}

	private void Send(string action, object obj, bool andWait = false)
	{
		string text = JsonConvert.SerializeObject(obj, Formatting.Indented);
		Dictionary<string, string> dictionary = new Dictionary<string, string>();
		dictionary.Add("data", text);
		LastMessage = text;
		LastResponse = string.Empty;
		string text2 = ReportUrl.Replace("{action}", action);
		if (Facepunch.Application.Integration.DebugOutput)
		{
			Debug.Log($"[Analytics] Sending {text2}");
		}
		try
		{
			WebUtil.Post(text2, dictionary, andWait, null);
		}
		catch (Exception ex)
		{
			Debug.LogWarning("Analytic Exception: " + ex.Message);
			Debug.LogWarning(ex.StackTrace);
		}
		LastSend = DateTime.UtcNow;
	}

	public IEnumerator KeepAlive()
	{
		float minutesToWait = 4f;
		while (true)
		{
			yield return new WaitForSeconds(60f * minutesToWait);
			SendSessionUpdate();
			if (minutesToWait < 32f)
			{
				minutesToWait *= 2f;
			}
		}
	}

	private void SendSessionUpdate(bool andWait = false)
	{
		SessionUpdate sessionUpdate = new SessionUpdate();
		sessionUpdate.Uid = Uid;
		sessionUpdate.Sid = SessionId;
		sessionUpdate.Frames = Performance.CategorizedFrameCount;
		sessionUpdate.Mem = Performance.MemoryUsage;
		sessionUpdate.Gc = Performance.GarbageCollections;
		sessionUpdate.StatText = ((Stats != null) ? JsonConvert.SerializeObject(Stats) : string.Empty);
		SessionUpdate obj = sessionUpdate;
		Send("update", obj, andWait);
	}

	public static void ForceSendSessionUpdateDebug()
	{
		if (Facepunch.Application.Analytics != null)
		{
			Facepunch.Application.Analytics.SendSessionUpdate();
		}
	}

	public static void RecordAdd(string category, string name, double val)
	{
		Stats.GetCategory(category).AddSum(name, val);
	}

	public static void RecordReplace(string category, string name, double val)
	{
		Stats.GetCategory(category).AddReplace(name, val);
	}

	public static void RecordAverage(string category, string name, double val)
	{
		Stats.GetCategory(category).AddAverage(name, val);
	}
}
