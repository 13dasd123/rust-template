using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Text;
using Facepunch;
using Facepunch.Extend;
using Facepunch.Math;
using Newtonsoft.Json;
using UnityEngine;
using UnityEngine.SceneManagement;

public class ExceptionReporter : MonoBehaviour
{
	private static readonly Stopwatch LastReportTime = Stopwatch.StartNew();

	private static int _reportsSentCounter;

	public static bool Disabled { get; set; }

	public static string PublicKey { get; set; }

	public static string SecretKey { get; set; }

	public static string Host { get; set; }

	public static string ProjectId { get; set; }

	private static Dictionary<string, string> Headers
	{
		get
		{
			string text = Epoch.Current.ToString();
			Dictionary<string, string> dictionary = new Dictionary<string, string>();
			dictionary.Add("X-Sentry-Auth", "Sentry sentry_version=5, sentry_client=FacepunchER/1.0, sentry_timestamp=" + text + ", sentry_key=" + PublicKey + ", sentry_secret=" + SecretKey);
			return dictionary;
		}
	}

	internal static void InstallHooks()
	{
		UnityEngine.Application.logMessageReceived += OnLogMessage;
	}

	private static void OnLogMessage(string message, string stackTrace, LogType type)
	{
		if (!Disabled && type == LogType.Exception)
		{
			if (LastReportTime.Elapsed.TotalSeconds > 60.0)
			{
				LastReportTime.Reset();
				LastReportTime.Start();
				_reportsSentCounter = 0;
			}
			if (_reportsSentCounter < 5)
			{
				LastReportTime.Reset();
				LastReportTime.Start();
				_reportsSentCounter++;
				SendReport(message, stackTrace);
			}
		}
	}

	public static void InitializeFromUrl(string url)
	{
		string[] array = url.Replace("https://", "").Split('/', ':', '@');
		PublicKey = array[0];
		SecretKey = array[1];
		Host = array[2];
		ProjectId = array[3];
	}

	public static void SendReport(string exception, string stacktrace)
	{
		Report report = new Report();
		report.release = BuildInfo.Current.Scm.ChangeId;
		report.message = exception.Truncate(250, "");
		report.platform = "csharp";
		report.event_id = Guid.NewGuid().ToString("N");
		report.stacktrace = new Report.StackTrace(stacktrace);
		report.tags = new Dictionary<string, string>();
		report.tags.Add("memory", Mathf.RoundToInt(SystemInfo.systemMemorySize / 1024) + "gb");
		report.tags.Add("operatingSystem", SystemInfo.operatingSystem);
		report.tags.Add("batteryStatus", SystemInfo.batteryStatus.ToString());
		report.tags.Add("deviceModel", SystemInfo.deviceModel);
		report.tags.Add("processorType", SystemInfo.processorType);
		report.tags.Add("graphicsDeviceName", SystemInfo.graphicsDeviceName);
		report.tags.Add("graphicsMemorySize", Mathf.RoundToInt(SystemInfo.graphicsMemorySize / 1024) + "gb");
		report.tags.Add("architecture", (IntPtr.Size == 4) ? "x86" : "x64");
		report.tags.Add("level", SceneManager.GetActiveScene().name);
		report.tags.Add("qualitylevel", QualitySettings.GetQualityLevel().ToString());
		string s = JsonConvert.SerializeObject(report);
		new WWW("https://" + Host + "/api/" + ProjectId + "/store/", Encoding.ASCII.GetBytes(s), Headers);
	}
}
