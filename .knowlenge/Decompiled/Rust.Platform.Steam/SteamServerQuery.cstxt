using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Rust.Platform.Steam;
using Steamworks;
using Steamworks.Data;
using Steamworks.ServerList;

public class SteamServerQuery : IServerQuery, IDisposable
{
	public ServerQuerySet QuerySet { get; }

	public Base Query { get; private set; }

	public IReadOnlyList<ServerInfo> Servers { get; }

	public event Action<ServerInfo> OnServerFound;

	public SteamServerQuery(ServerQuerySet set, Base query)
	{
		QuerySet = set;
		Query = query ?? throw new ArgumentNullException("query");
		List<ServerInfo> serverList = new List<ServerInfo>();
		Servers = serverList;
		Query.OnChanges += delegate
		{
			foreach (Steamworks.Data.ServerInfo item in Query.Responsive)
			{
				ServerInfo serverInfo = SteamPlatform.ToPlatformServer(item);
				serverList.Add(serverInfo);
				this.OnServerFound?.Invoke(serverInfo);
			}
			Query.Responsive.Clear();
		};
	}

	public void Dispose()
	{
		if (SteamClient.IsValid)
		{
			Query?.Dispose();
		}
		Query = null;
	}

	public void AddFilter(string key, string value)
	{
		Query.AddFilter(key, value);
	}

	public Task RunQueryAsync(double timeoutInSeconds)
	{
		return Query.RunQueryAsync((float)timeoutInSeconds);
	}
}
