using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using Network;
using SilentOrbit.ProtocolBuffers;
using UnityEngine;

public class Connection
{
	public enum State
	{
		Unconnected,
		Connecting,
		InQueue,
		Welcoming,
		Connected,
		Disconnected
	}

	public struct Validation
	{
		public uint entityUpdates;
	}

	public class ClientInfo
	{
		public Dictionary<string, string> info = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

		public void Set(string k, string v)
		{
			info[k] = v;
		}

		public string GetString(string k, string def = "")
		{
			if (info.TryGetValue(k, out var value))
			{
				return value;
			}
			return def;
		}

		public float GetFloat(string k, float def = 0f)
		{
			string @string = GetString(k, null);
			if (@string == null)
			{
				return def;
			}
			if (float.TryParse(@string, out var result))
			{
				return result;
			}
			return def;
		}

		public int GetInt(string k, int def = 0)
		{
			string @string = GetString(k, null);
			if (@string == null)
			{
				return def;
			}
			if (int.TryParse(@string, out var result))
			{
				return result;
			}
			return def;
		}

		public bool GetBool(string k, bool def = false)
		{
			string @string = GetString(k, null);
			if (@string == null)
			{
				return def;
			}
			if (bool.TryParse(@string, out var result))
			{
				return result;
			}
			return def;
		}
	}

	private static MemoryStream reusableStream = new MemoryStream(1048576);

	protected MemoryStream recordStream;

	protected BinaryWriter recordWriter;

	protected Stopwatch recordTime;

	protected string recordFilename;

	protected IDemoHeader recordHeader;

	public State state;

	public bool active;

	public bool connected;

	public uint authLevel;

	public uint encryptionLevel;

	public bool decryptIncoming;

	public bool encryptOutgoing;

	public bool rejected;

	public string authStatus;

	public byte[] token;

	public bool hasRequestedWorld;

	public ulong guid;

	public ulong userid;

	public ulong ownerid;

	public string username;

	public string os;

	public uint protocol;

	private TimeAverageValueData[] packetsPerSecond = new TimeAverageValueData[26];

	public double connectionTime;

	public string ipaddress;

	public MonoBehaviour player;

	public Validation validate;

	public ClientInfo info = new ClientInfo();

	public TimeSpan RecordTimeElapsed
	{
		get
		{
			if (recordTime == null)
			{
				return TimeSpan.Zero;
			}
			return recordTime.Elapsed;
		}
	}

	public string RecordFilename => recordFilename;

	public int RecordFilesize => (int)recordStream.Length;

	public bool IsRecording => recordStream != null;

	public bool isAuthenticated => authStatus == "ok";

	public bool StartRecording(string targetFilename, IDemoHeader header)
	{
		if (recordStream != null)
		{
			return false;
		}
		recordFilename = targetFilename;
		recordHeader = header;
		recordStream = new MemoryStream();
		recordWriter = new BinaryWriter(recordStream);
		recordTime = Stopwatch.StartNew();
		return true;
	}

	public void StopRecording()
	{
		if (recordStream == null)
		{
			return;
		}
		if (recordHeader != null)
		{
			Directory.CreateDirectory(Path.GetDirectoryName(recordFilename));
			using (FileStream fileStream = new FileStream(recordFilename, FileMode.Create))
			{
				using BinaryWriter writer = new BinaryWriter(fileStream);
				recordHeader.Length = (long)recordTime.Elapsed.TotalMilliseconds;
				recordHeader.Write(writer);
				recordStream.WriteTo(fileStream);
			}
			recordHeader = null;
		}
		recordTime = null;
		recordWriter.Close();
		recordWriter = null;
		recordStream.Dispose();
		recordStream = null;
		recordFilename = null;
	}

	public void RecordPacket(byte packetId, IProto proto)
	{
		if (IsRecording)
		{
			reusableStream.SetLength(0L);
			proto.WriteToStream(reusableStream);
			byte[] buffer = reusableStream.GetBuffer();
			int num = (int)reusableStream.Length;
			recordWriter.Write(num + 1);
			recordWriter.Write((long)recordTime.Elapsed.TotalMilliseconds);
			recordWriter.Write((byte)(packetId + 140));
			recordWriter.Write(buffer, 0, num);
			recordWriter.Write('\0');
			recordWriter.Write('\0');
		}
	}

	public void RecordPacket(Stream stream)
	{
		if (IsRecording)
		{
			byte[] buffer = reusableStream.GetBuffer();
			int num = (int)stream.Length;
			long position = stream.Position;
			stream.Position = 0L;
			stream.Read(buffer, 0, num);
			stream.Position = position;
			recordWriter.Write(num);
			recordWriter.Write((long)recordTime.Elapsed.TotalMilliseconds);
			recordWriter.Write(buffer, 0, num);
			recordWriter.Write('\0');
			recordWriter.Write('\0');
		}
	}

	public virtual void OnDisconnected()
	{
		player = null;
		guid = 0uL;
		ResetPacketsPerSecond();
		hasRequestedWorld = false;
	}

	public void ResetPacketsPerSecond()
	{
		for (int i = 0; i < packetsPerSecond.Length; i++)
		{
			packetsPerSecond[i].Reset();
		}
	}

	public void AddPacketsPerSecond(Message.Type message)
	{
		AddPacketsPerSecond((int)message);
	}

	public void AddPacketsPerSecond(int index = 0)
	{
		if (index >= 0 && index < packetsPerSecond.Length)
		{
			packetsPerSecond[index].Increment();
		}
	}

	public ulong GetPacketsPerSecond(Message.Type message)
	{
		return GetPacketsPerSecond((int)message);
	}

	public ulong GetPacketsPerSecond(int index = 0)
	{
		if (index < 0 || index >= packetsPerSecond.Length)
		{
			return 0uL;
		}
		return packetsPerSecond[index].Calculate();
	}

	public float GetSecondsConnected()
	{
		return (float)(TimeEx.realtimeSinceStartup - connectionTime);
	}

	public override string ToString()
	{
		return $"{ipaddress}/{userid}/{username}";
	}
}
